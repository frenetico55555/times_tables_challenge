<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Interactive multiplication tables game for kids ages 6-12. Learn multiplication from 1 to 12 with adaptive learning, real-time statistics, and fun animations!">
  <meta name="keywords" content="multiplication, tables, game, math, education, kids, learning, interactive, adaptive">
  <meta name="author" content="Rodrigo Figueroa">
  <meta name="version" content="1.0.1">
  <meta name="theme-color" content="#667eea">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://frenetico55555.github.io/times_tables_challenge/">
  <meta property="og:title" content="üéÆ Multiplication Tables Game (1 to 12) ‚≠ê">
  <meta property="og:description" content="Fun and interactive game to help kids master multiplication tables!">
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://frenetico55555.github.io/times_tables_challenge/">
  <meta property="twitter:title" content="üéÆ Multiplication Tables Game (1 to 12) ‚≠ê">
  <meta property="twitter:description" content="Fun and interactive game to help kids master multiplication tables!">
  
  <title>üéÆ Multiplication Tables Game 1-12 ‚≠ê</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    
    table { 
      border-collapse: separate;
      border-spacing: 2px;
      margin: 0;
      font-size: clamp(0.7em, 1.2vw, 1em);
      width: 100%;
      max-width: min(70vw, 900px);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: clamp(8px, 1vw, 12px);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
      animation: tableFloat 3s ease-in-out infinite;
    }
    
    @keyframes tableFloat {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-5px); }
    }
    
    th, td { 
      border: none;
      padding: clamp(0.2em, 0.5vw, 0.35em);
      text-align: center; 
      width: clamp(30px, 4vw, 48px);
      height: clamp(20px, 3vw, 32px);
      box-sizing: border-box;
      font-weight: 600;
      border-radius: 8px;
      transition: all 0.3s ease;
      font-size: clamp(0.75em, 1vw, 1em);
    }
    
    th { 
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      font-weight: 700;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
      box-shadow: 0 2px 8px rgba(240, 147, 251, 0.3);
    }
    
    td {
      background: white;
      color: #333;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    td:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .highlight-row th, .highlight-row td { 
      background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%) !important; 
      animation: pulse 0.6s ease-in-out;
    }
    .highlight-col { 
      background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%) !important; 
      animation: pulse 0.6s ease-in-out;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.08); }
    }
    
    .highlight-row.red th, .highlight-row.red td,
    .highlight-col.red { 
      background: linear-gradient(135deg, #ff7675 0%, #d63031 100%) !important;
      animation: shake 0.5s ease-in-out;
    }
    .highlight-row.green th, .highlight-row.green td,
    .highlight-col.green { 
      background: linear-gradient(135deg, #55efc4 0%, #00b894 100%) !important;
      animation: bounce 0.6s ease-in-out;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    input[type="number"].cell-input { 
      width: 90%;
      max-width: 44px;
      font-size: clamp(0.9em, 1vw, 1.1em); 
      text-align: center; 
      padding: 2px;
      margin: 0;
      border: 3px solid #667eea;
      border-radius: 8px;
      font-weight: 700;
      color: #667eea;
      background: #fff;
      transition: all 0.3s ease;
      font-family: 'Quicksand', sans-serif;
    }
    
    input[type="number"].cell-input:focus {
      outline: none;
      border-color: #f093fb;
      box-shadow: 0 0 15px rgba(240, 147, 251, 0.5);
      transform: scale(1.1);
    }
    
    
    #juego-controls { 
      margin: 0;
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      padding: clamp(15px, 2vh, 25px);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      width: 100%;
    }
    
    #juego-controls > div:first-child {
      margin-bottom: 1.5em;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    #juego-controls button,
    #juego-controls a {
      margin: 5px 0 !important;
      width: 100%;
    }
    
    #juego-controls a button {
      width: 100%;
    }
    
    #stats { 
      margin: 0;
      font-size: 1em;
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-family: 'Quicksand', sans-serif;
      font-weight: 600;
    }
    
    #stats span { 
      background: white;
      padding: clamp(8px, 1.2vh, 12px) clamp(12px, 1.5vw, 16px);
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      color: #555;
      text-align: left;
      width: 100%;
      font-size: clamp(0.85em, 1vw, 1em);
    }
    
    #stats span:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(102, 126, 234, 0.3);
    }
    
    button {
      font-size: clamp(0.85em, 1.1vw, 1em); 
      padding: clamp(10px, 1.2vh, 12px) clamp(18px, 2vw, 24px); 
      margin: 0;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 700;
      font-family: 'Quicksand', sans-serif;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    #start-btn { 
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
      font-size: clamp(1.1em, 1.4vw, 1.3em);
      padding: clamp(16px, 2.2vh, 20px) clamp(28px, 3vw, 36px);
      animation: pulseButton 2s infinite;
      margin-top: 0.3em;
    }
    
    @keyframes pulseButton {
      0%, 100% { transform: scale(1); box-shadow: 0 4px 15px rgba(56, 239, 125, 0.4); }
      50% { transform: scale(1.05); box-shadow: 0 6px 20px rgba(56, 239, 125, 0.6); }
    }
    
    #start-btn:hover {
      transform: scale(1.08);
      box-shadow: 0 8px 25px rgba(56, 239, 125, 0.5);
    }
    
    #reset-btn {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      color: white;
    }
    
    #reset-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(250, 112, 154, 0.4);
    }
    
    #screenshot-btn {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
    }
    
    #screenshot-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
    }
    
    a button {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }
    
    a button:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(240, 147, 251, 0.4);
    }
    
    .oculto { visibility: hidden; }
    
    html, body {
      width: 100vw;
      min-height: 100vh;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      font-family: 'Quicksand', sans-serif;
    }
    
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      padding: 1vh 1vw;
      overflow-x: hidden;
    }
    
    #main-container {
      display: flex;
      flex-direction: row;
      gap: 2vw;
      width: 98vw;
      max-width: 100%;
      align-items: flex-start;
      justify-content: center;
      margin-top: 1vh;
    }
    
    #left-panel {
      display: flex;
      flex-direction: column;
      gap: 1vh;
      width: clamp(280px, 22vw, 360px);
      flex-shrink: 0;
    }
    
    #right-panel {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      min-width: 0;
    }
    
    #score-container {
      display: flex;
      gap: 20px;
      margin-top: 15px;
      justify-content: center;
      width: 100%;
      max-width: 800px;
    }
    
    #score-container span {
      background: white;
      padding: 12px 24px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      color: #555;
      text-align: center;
      font-size: clamp(0.95em, 1.1vw, 1.1em);
      font-family: 'Quicksand', sans-serif;
      font-weight: 600;
      flex: 1;
      min-width: 150px;
    }
    
    #score-container span:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(102, 126, 234, 0.3);
    }
    
    #score-container #score {
      background: linear-gradient(135deg, #fff5f5 0%, #ffe8e8 100%);
    }
    
    #score-container #highscore {
      background: linear-gradient(135deg, #fff9e6 0%, #ffe8b3 100%);
    }
    
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    h1 {
      font-family: 'Fredoka One', cursive;
      font-size: clamp(1.5em, 4vw, 2.5em);
      color: white;
      text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
      margin: 10px 0;
      text-align: center;
      animation: titleBounce 2s ease-in-out infinite;
    }
    
    @keyframes titleBounce {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-10px) rotate(-2deg); }
    }
    
    label {
      font-weight: 700;
      color: #2d3436;
      font-size: 1.1em;
      text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
    }
    
    input[type="text"] {
      font-size: clamp(0.95em, 1.1vw, 1.1em);
      padding: clamp(8px, 1vh, 10px) clamp(12px, 1.5vw, 15px);
      border: 3px solid #667eea;
      border-radius: 15px;
      font-family: 'Quicksand', sans-serif;
      font-weight: 600;
      color: #2d3436;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    input[type="text"]:focus {
      outline: none;
      border-color: #f093fb;
      box-shadow: 0 0 15px rgba(240, 147, 251, 0.5);
      transform: scale(1.02);
    }
    
    input[type="password"] {
      font-size: clamp(0.95em, 1.1vw, 1.1em);
      padding: clamp(8px, 1vh, 10px) clamp(12px, 1.5vw, 15px);
      border: 3px solid #667eea;
      border-radius: 15px;
      font-family: 'Quicksand', sans-serif;
      font-weight: 600;
      color: #2d3436;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    input[type="password"]:focus {
      outline: none;
      border-color: #f093fb;
      box-shadow: 0 0 15px rgba(240, 147, 251, 0.5);
      transform: scale(1.02);
    }
    
    #feedback {
      font-size: clamp(1em, 1.2vw, 1.2em);
      font-weight: 700;
      margin-top: clamp(10px, 1.5vh, 15px);
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      animation: feedbackPop 0.5s ease;
      text-align: center;
      display: block;
      padding: clamp(8px, 1vh, 10px);
      border-radius: 12px;
      background: rgba(255,255,255,0.2);
    }
    
    @keyframes feedbackPop {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    
    #highscore {
      transition: color 0.3s, text-shadow 0.3s;
      background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%) !important;
      font-size: 1.2em !important;
    }
    
    .highscore-flash {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%) !important;
      color: white !important;
      text-shadow: 0 0 20px #ff5252, 0 0 40px #ff5252;
      animation: highscore-bounce 1s cubic-bezier(.36,1.5,.64,1) 1;
    }
    
    @keyframes highscore-bounce {
      0%   { transform: scale(1) translateY(0) rotate(0deg);}
      10%  { transform: scale(1.3) translateY(-12px) rotate(-8deg);}
      20%  { transform: scale(1.4) translateY(-22px) rotate(8deg);}
      30%  { transform: scale(1.3) translateY(-12px) rotate(-8deg);}
      40%  { transform: scale(1.2) translateY(-6px) rotate(4deg);}
      50%  { transform: scale(1.15) translateY(-3px) rotate(-3deg);}
      60%  { transform: scale(1.1) translateY(0) rotate(2deg);}
      70%  { transform: scale(1.15) translateY(-3px) rotate(-2deg);}
      80%  { transform: scale(1.1) translateY(0) rotate(0deg);}
      100% { transform: scale(1) translateY(0) rotate(0deg);}
    }
    
    /* User Registration System Styles */
    #user-selector {
      background: rgba(255,255,255,0.05);
      padding: 1em;
      border-radius: 15px;
      border: 2px solid rgba(255,255,255,0.1);
    }
    
    #user-selector input[type="radio"] {
      margin: 0;
      transform: scale(1.2);
    }
    
    #user-selector label {
      color: white;
      font-weight: 600;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    
    #existing-users {
      border: 3px solid #667eea;
      border-radius: 15px;
      font-family: 'Quicksand', sans-serif;
      font-weight: 600;
      color: #2d3436;
      background: white;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: clamp(8px, 1vh, 10px) clamp(12px, 1.5vw, 15px);
    }
    
    #existing-users:focus {
      outline: none;
      border-color: #f093fb;
      box-shadow: 0 0 15px rgba(240, 147, 251, 0.5);
      transform: scale(1.02);
    }
    
    #user-stats {
      color: white;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .user-badge {
      display: inline-block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 0.2em 0.6em;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
      margin-left: 0.5em;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    
    #password-section {
      background: rgba(255,255,255,0.03);
      padding: 0.8em;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
      margin-top: 0.5em;
    }
    
    .password-error {
      color: #ff6b6b !important;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      font-weight: 600;
    }
    
    .password-success {
      color: #55efc4 !important;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      font-weight: 600;
    }
    
    .correct {
      background: linear-gradient(135deg, #55efc4 0%, #00b894 100%) !important;
      color: white !important;
      font-weight: 700;
      animation: correctPop 0.6s ease;
    }
    
    @keyframes correctPop {
      0% { transform: scale(0) rotate(0deg); }
      50% { transform: scale(1.3) rotate(10deg); }
      100% { transform: scale(1) rotate(0deg); }
    }
    
    .incorrect {
      background: linear-gradient(135deg, #ff7675 0%, #d63031 100%) !important;
      color: white !important;
      font-weight: 700;
      animation: incorrectShake 0.5s ease;
    }
    
    @keyframes incorrectShake {
      0%, 100% { transform: translateX(0) rotate(0deg); }
      20% { transform: translateX(-8px) rotate(-5deg); }
      40% { transform: translateX(8px) rotate(5deg); }
      60% { transform: translateX(-8px) rotate(-5deg); }
      80% { transform: translateX(8px) rotate(5deg); }
    }
    
    /* Decorative stars */
    .star {
      position: absolute;
      font-size: 2em;
      animation: twinkle 2s infinite;
      pointer-events: none;
      z-index: 1;
    }
    
    @keyframes twinkle {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
    }
    
    @keyframes modalPop {
      0% { transform: scale(0) rotate(-180deg); opacity: 0; }
      50% { transform: scale(1.2) rotate(10deg); }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    
    @media (max-width: 1024px) {
      #main-container {
        flex-direction: column;
        align-items: center;
        width: 95vw;
      }
      
      #left-panel {
        width: 100%;
        max-width: 500px;
      }
      
      #right-panel {
        width: 100%;
      }
      
      table {
        max-width: 95vw;
        font-size: clamp(0.65em, 1.5vw, 0.9em);
      }
      
      #stats {
        flex-direction: row;
        flex-wrap: wrap;
      }
      
      #stats span {
        flex: 1 1 calc(50% - 5px);
        min-width: 140px;
      }
      
      #score-container {
        margin-top: 20px;
      }
      
      #score-container span {
        font-size: clamp(0.9em, 1.3vw, 1em);
      }
    }
    
    /* Mobile Challenge Display */
    #mobile-challenge {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px 15px 15px 15px;
      border-radius: 25px;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
      margin: 15px auto;
      max-width: 95vw;
      min-height: auto;
    }
    
    #mobile-challenge-question {
      font-size: 2.8em;
      font-weight: 700;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
      margin-bottom: 15px;
      font-family: 'Fredoka One', cursive;
      text-align: center;
    }
    
    #mobile-challenge-input {
      width: 180px;
      height: 70px;
      font-size: 2.5em;
      text-align: center;
      border: 4px solid #f093fb;
      border-radius: 15px;
      font-weight: 700;
      color: #667eea;
      background: white;
      font-family: 'Quicksand', sans-serif;
      margin-bottom: 12px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.2);
      -webkit-user-select: text;
      user-select: text;
      -webkit-tap-highlight-color: transparent;
    }
    
    #mobile-challenge-input:focus {
      outline: none;
      border-color: #ffeaa7;
      box-shadow: 0 0 30px rgba(255, 234, 167, 0.8);
      transform: scale(1.02);
    }
    
    #mobile-challenge-submit {
      padding: 14px 35px;
      font-size: 1.3em;
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
      border: none;
      border-radius: 40px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(56, 239, 125, 0.4);
      font-family: 'Quicksand', sans-serif;
      text-transform: uppercase;
      letter-spacing: 1px;
      -webkit-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    #mobile-challenge-submit:active {
      transform: scale(0.95);
    }
    
    #mobile-feedback {
      font-size: 2em;
      font-weight: 700;
      margin-top: 20px;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      text-align: center;
      min-height: 40px;
    }
    
    /* Mobile compact stats bar */
    #mobile-stats-bar {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(102, 126, 234, 0.95);
      padding: 8px 15px;
      z-index: 1000;
      font-size: 0.85em;
      color: white;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      font-family: 'Quicksand', sans-serif;
    }
    
    #mobile-stats-bar span {
      margin: 0 10px;
      display: inline-block;
    }
    
    @media (max-width: 700px) {
      h1 { font-size: clamp(1.2em, 4.5vw, 1.6em); }
      
      #main-container {
        width: 98vw;
        gap: 0.5vh;
      }
      
      /* Hide decorative stars on mobile to reduce visual clutter */
      .star {
        display: none;
      }
      
      /* Hide stats panel before game starts on mobile to save space */
      #stats {
        display: none;
      }
      
      /* Hide the full table on mobile */
      table { 
        display: none;
      }
      
      /* Hide score container on mobile when game is active */
      #score-container {
        display: none;
      }
      
      /* Show mobile challenge display */
      #mobile-challenge {
        display: flex;
      }
      
      /* Show Enter button on mobile for easy submission */
      #mobile-challenge-submit {
        display: block;
        padding: 12px 30px;
        font-size: 1.2em;
        margin-top: 6px;
      }
      
      /* Show compact stats bar on mobile when game is active */
      body.mobile-game-active #mobile-stats-bar {
        display: block;
      }
      
      /* Hide left panel when game is active on mobile */
      body.mobile-game-active #left-panel {
        display: none;
      }
      
      /* Adjust main container when game is active */
      body.mobile-game-active #main-container {
        margin-top: 50px;
      }
      
      /* Hide h1 when game is active on mobile */
      body.mobile-game-active h1 {
        display: none;
      }
      
      button { 
        font-size: clamp(0.75em, 1.8vw, 0.85em); 
        padding: clamp(6px, 1vh, 8px) clamp(12px, 2.5vw, 16px); 
      }
      
      #start-btn {
        font-size: clamp(0.85em, 2.2vw, 1em);
      }
      
      #stats { 
        font-size: clamp(0.8em, 1.8vw, 0.95em); 
        flex-direction: column; 
      }
      
      #stats span { 
        flex: 1 1 100%; 
      }
      
      .star {
        font-size: clamp(1.2em, 3vw, 1.5em);
      }
    }
    
    @media (min-width: 1400px) {
      #left-panel {
        width: clamp(320px, 20vw, 400px);
      }
      
      table {
        max-width: min(60vw, 1000px);
      }
    }
  </style>
</head>
<body>
  <!-- Decorative stars -->
  <div class="star" style="top: 10%; left: 10%;">‚≠ê</div>
  <div class="star" style="top: 15%; right: 15%; animation-delay: 0.5s;">‚ú®</div>
  <div class="star" style="top: 80%; left: 20%; animation-delay: 1s;">üåü</div>
  <div class="star" style="top: 85%; right: 10%; animation-delay: 1.5s;">üí´</div>
  <div class="star" style="top: 40%; left: 5%; animation-delay: 0.8s;">‚≠ê</div>
  <div class="star" style="top: 50%; right: 8%; animation-delay: 1.2s;">‚ú®</div>
  
  <!-- Mobile compact stats bar -->
  <div id="mobile-stats-bar">
    <span id="mobile-avg">üìä Avg: -- s</span>
    <span id="mobile-score">üéØ Current Session Score: --</span>
  </div>
  
  <script>
    window.addEventListener('DOMContentLoaded', function() {
      setTimeout(function() {
        alert(
          'üéÆ Hello! We created this math game for our kids to help them learn the multiplication tables. They loved it! They started trying to beat their "higher score" in exchange for a prize, and in just one week they knew all the tables, haha. They liked it so much that they shared it with their friends, and several parents asked us for the game, so we uploaded it here. Before publishing it on a pro site, we are asking for suggestions to improve it. If you want to help make this tool better for kids, we would appreciate your feedback by clicking the "Send Suggestions" button below. Thank you very much! ‚≠ê'
        );
      }, 100);
    });
  </script>
  <h1>üéÆ Multiplication Tables Game (1 to 12) ‚≠ê</h1>
  
  <div id="main-container">
    <!-- Left Panel: Controls and Stats -->
    <div id="left-panel">
      <div id="juego-controls">
        <div style="margin-bottom: 0.5em;">
          <label for="user-selector" style="font-weight:bold;">üë§ Player:</label>
          <div id="user-selector" style="margin-top: 0.5em;">
            <div style="display: flex; gap: 0.5em; margin-bottom: 0.5em;">
              <input type="radio" id="existing-user" name="user-type" value="existing" style="margin-right: 0.3em;">
              <label for="existing-user" style="font-weight: normal;">Select existing player</label>
              <input type="radio" id="new-user" name="user-type" value="new" checked style="margin-left: 1em; margin-right: 0.3em;">
              <label for="new-user" style="font-weight: normal;">New player</label>
            </div>
            
            <select id="existing-users" style="font-size:1.1em; width: 100%; margin-bottom: 0.5em; display: none;">
              <option value="">-- Select a player --</option>
            </select>
            
            <input type="text" id="nombre-jugador" style="font-size:1.1em; width: 100%; margin-bottom: 0.5em;" placeholder="Enter new player name..." autocomplete="off">
            
            <div id="password-section" style="display: none;">
              <label for="user-password" style="font-weight: bold; font-size: 0.9em; display: block; margin-bottom: 0.3em; color: #2d3748;">üîê Simple Password:</label>
              <input type="password" id="user-password" style="font-size:1.1em; width: 100%; margin-bottom: 0.3em;" placeholder="Enter your simple password..." autocomplete="off">
              <div style="font-size: 0.8em; color: #4a5568; margin-bottom: 0.5em;">
                üí° <em>Use something simple like your age, favorite number, or pet's name</em>
              </div>
            </div>
            
            <div id="user-stats" style="margin-top: 0.5em; padding: 0.8em; background: rgba(255,255,255,0.25); border-radius: 8px; font-size: 0.95em; display: none; border: 1px solid rgba(255,255,255,0.3);">
              <div style="color: #1a202c; margin-bottom: 0.3em;">üéÆ <strong>Sessions played:</strong> <span id="user-sessions">0</span></div>
              <div style="color: #1a202c; margin-bottom: 0.3em;">üèÜ <strong>All-time best score:</strong> <span id="user-best">--</span></div>
              <div style="color: #1a202c;">üìÖ <strong>Last session:</strong> <span id="user-last-played">Never</span></div>
            </div>
            <div id="user-history-panel" style="margin-top: 0.5em; padding: 0.8em; background: rgba(255,255,255,0.2); border-radius: 8px; font-size: 0.9em; display: none; max-height: 180px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.25);">
              <ul id="user-history-list" style="list-style: none; padding-left: 0; margin: 0;">
                <!-- Score history will be populated here -->
              </ul>
            </div>
          </div>
        </div>
        <button id="start-btn" onclick="iniciarJuego()">üöÄ Start Game!</button>
        <button id="stop-btn" onclick="detenerSesion()" style="display: none; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">‚èπÔ∏è Stop Game Session</button>
        <a href="https://forms.gle/AvHgLfGM7LdmSfbt6" target="_blank" rel="noopener" style="text-decoration:none;">
          <button type="button">üí° Send Suggestions</button>
        </a>
        <span id="feedback"></span>
      </div>      <div id="stats">
  <span id="cronometro">‚è±Ô∏è Current session time: 00:00</span>
  <span id="ultimo-tiempo" style="display: none;">‚ö° Last trial: -- s</span>
  <span id="promedio-tiempo">üìä Avg time (last 10): -- s</span>
  <span id="porcentaje-correctas">‚úÖ Avg accuracy (last 10): -- %</span>
      </div>
    </div>
    
    <!-- Right Panel: Game Table -->
    <div id="right-panel">
  <!-- Mobile Challenge Display -->
  <div id="mobile-challenge">
    <div id="mobile-challenge-question">? √ó ? = ?</div>
    <input type="number" id="mobile-challenge-input" autocomplete="off" inputmode="numeric" pattern="[0-9]*">
    <button id="mobile-challenge-submit" type="button" onmousedown="event.preventDefault(); verificarRespuestaMobile(); return false;" ontouchstart="event.preventDefault(); verificarRespuestaMobile(); return false;" onclick="event.preventDefault(); return false;">‚èé ENTER</button>
    <div id="mobile-feedback"></div>
  </div>
  
  <table id="matriz">
    <thead>
      <tr>
        <th></th>
        <!-- Encabezados de columna -->
        <script>
          for(let i=1; i<=12; i++) {
            document.write('<th>' + i + '</th>');
          }
        </script>
      </tr>
    </thead>
    <tbody>
      <script>
        for(let i=1; i<=12; i++) {
          document.write('<tr>');
          document.write('<th>' + i + '</th>');
          for(let j=1; j<=12; j++) {
            document.write('<td data-row="'+i+'" data-col="'+j+'"></td>');
          }
          document.write('</tr>');
        }
      </script>
    </tbody>
  </table>
  
  <!-- Score displays below matrix -->
  <div id="score-container">
    <span id="score">üéØ Current Session Score: --</span>
    <span id="highscore">üèÜ Session best: --</span>
  </div>
    </div>
  </div>
  <!-- Firebase Configuration -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
    import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDhQvmDJG5XIwnvqlGuR-lJ5jYC0-TsLsM",
      authDomain: "multiplication-game-247e4.firebaseapp.com",
      projectId: "multiplication-game-247e4",
      storageBucket: "multiplication-game-247e4.firebasestorage.app",
      messagingSenderId: "36181569679",
      appId: "1:36181569679:web:e8e4292f15644dd56000fa",
      measurementId: "G-ENFV48G0KH"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // Make Firebase available globally
    window.db = db;
    window.firestore = { getDoc, setDoc, updateDoc, doc, collection, getDocs };
  </script>
  
  <script>
    // ============= USER REGISTRATION SYSTEM =============
    
    // User management variables
    let currentUser = null;
    let usersDatabase = {};
    
    // Load all users from Firebase
    async function loadUsersDatabase() {
      try {
        // First load from localStorage for immediate access
        const stored = localStorage.getItem('multiplicationGameUsers');
        if (stored) {
          usersDatabase = JSON.parse(stored);
        }
        
        // Then sync with Firebase to get all users
        const usersRef = window.firestore.collection(window.db, 'users');
        const querySnapshot = await window.firestore.getDocs(usersRef);
        
        querySnapshot.forEach((doc) => {
          const userData = doc.data();
          usersDatabase[doc.id] = userData;
        });
        
        // Save merged data back to localStorage
        localStorage.setItem('multiplicationGameUsers', JSON.stringify(usersDatabase));
        
        console.log('Loaded', Object.keys(usersDatabase).length, 'users from Firebase');
      } catch (error) {
        console.error('Error loading users from Firebase:', error);
        // Fallback to localStorage if Firebase fails
        try {
          const stored = localStorage.getItem('multiplicationGameUsers');
          if (stored) {
            usersDatabase = JSON.parse(stored);
          }
        } catch (localError) {
          console.error('Error loading from localStorage:', localError);
          usersDatabase = {};
        }
      }
    }
    
    // Save user to Firebase
    async function saveUserToFirebase(username, userData) {
      try {
        const userRef = window.firestore.doc(window.db, 'users', username);
        await window.firestore.setDoc(userRef, userData);
        console.log('User saved to Firebase successfully');
        return true;
      } catch (error) {
        console.error('Error saving to Firebase:', error);
        // Fallback to localStorage
        try {
          usersDatabase[username] = userData;
          localStorage.setItem('multiplicationGameUsers', JSON.stringify(usersDatabase));
          console.log('User saved to localStorage as fallback');
          return true;
        } catch (localError) {
          console.error('Error saving to localStorage:', localError);
          return false;
        }
      }
    }
    
    // Get user from Firebase
    async function getUserFromFirebase(username) {
      try {
        const userRef = window.firestore.doc(window.db, 'users', username);
        const userSnap = await window.firestore.getDoc(userRef);
        
        if (userSnap.exists()) {
          return userSnap.data();
        } else {
          return null;
        }
      } catch (error) {
        console.error('Error getting user from Firebase:', error);
        // Fallback to localStorage
        return usersDatabase[username] || null;
      }
    }
    
    // Save users to localStorage (fallback method)
    function saveUsersDatabase() {
      try {
        localStorage.setItem('multiplicationGameUsers', JSON.stringify(usersDatabase));
      } catch (error) {
        console.error('Error saving users database:', error);
      }
    }
    
    // Create or get user record
    async function createOrGetUser(username, password = null) {
      // First try to get user from Firebase
      let user = await getUserFromFirebase(username);
      
      if (!user) {
        if (!password) {
          throw new Error('Password required for new user');
        }
        // Create new user
        user = {
          name: username,
          password: password, // Store simple password (in real app would be hashed)
          createdAt: new Date().toISOString(),
          sessions: [],
          personalBest: null,
          totalSessions: 0,
          lastPlayed: null
        };
        
        // Save to Firebase
        await saveUserToFirebase(username, user);
        
        // Also save to local database for immediate access
        usersDatabase[username] = user;
      } else {
        // Also save to local database for immediate access
        usersDatabase[username] = user;
      }
      
      return user;
    }
    
    // Verify user password
    async function verifyUserPassword(username, password) {
      const user = await getUserFromFirebase(username);
      if (!user) return false;
      return user.password === password;
    }
    
    // Update user dropdown with registered users
    async function updateUserDropdown() {
      const dropdown = document.getElementById('existing-users');
      dropdown.innerHTML = '<option value="">-- Select a player --</option>';
      
      // Try to get users from Firebase first
      try {
        const usersRef = window.firestore.collection(window.db, 'users');
        // For now, we'll use the local database and load users as needed
        // In a full implementation, you might want to get all user names
        
        const users = Object.keys(usersDatabase).sort();
        users.forEach(username => {
          const option = document.createElement('option');
          option.value = username;
          option.textContent = username;
          dropdown.appendChild(option);
        });
      } catch (error) {
        console.error('Error updating user dropdown:', error);
        // Fallback to localStorage data
        const users = Object.keys(usersDatabase).sort();
        users.forEach(username => {
          const option = document.createElement('option');
          option.value = username;
          option.textContent = username;
          dropdown.appendChild(option);
        });
      }
    }
    
    // Show user statistics
    function showUserStats(username) {
      const user = usersDatabase[username];
      if (!user) return;
      
      document.getElementById('user-sessions').textContent = user.totalSessions;
      document.getElementById('user-best').textContent = user.personalBest ? user.personalBest.toFixed(1) : '--';
      document.getElementById('user-last-played').textContent = user.lastPlayed ? 
        new Date(user.lastPlayed).toLocaleDateString() : 'Never';
      document.getElementById('user-stats').style.display = 'block';

      // Show only the sparkline, without the scores list
      const historyPanel = document.getElementById('user-history-panel');
      const historyList = document.getElementById('user-history-list');
      
      // Hide the scores list
      historyList.style.display = 'none';
      
      if (user.sessions && user.sessions.length > 0) {
        historyPanel.style.display = 'block';
      } else {
        historyPanel.style.display = 'block';
      }
    }
    
    // Hide user statistics
    function hideUserStats() {
      document.getElementById('user-stats').style.display = 'none';
    }
    
    // Handle user type selection
    function handleUserTypeChange() {
      const existingRadio = document.getElementById('existing-user');
      const newRadio = document.getElementById('new-user');
      const dropdown = document.getElementById('existing-users');
      const nameInput = document.getElementById('nombre-jugador');
      const passwordSection = document.getElementById('password-section');
      
      if (existingRadio.checked) {
        dropdown.style.display = 'block';
        nameInput.style.display = 'none';
        passwordSection.style.display = 'none';
        nameInput.value = '';
        clearPasswordField();
        hideUserStats();
        currentUser = null;
      } else {
        dropdown.style.display = 'none';
        nameInput.style.display = 'block';
        passwordSection.style.display = 'none'; // Will show when name is entered
        dropdown.value = '';
        clearPasswordField();
        hideUserStats();
        currentUser = null;
      }
    }
    
    // Clear password field and reset styling
    function clearPasswordField() {
      const passwordInput = document.getElementById('user-password');
      passwordInput.value = '';
      passwordInput.style.borderColor = '#667eea';
      passwordInput.style.backgroundColor = 'white';
    }
    
    // Handle existing user selection
    async function handleExistingUserSelection() {
      const dropdown = document.getElementById('existing-users');
      const username = dropdown.value;
      const passwordSection = document.getElementById('password-section');
      
      if (username) {
        // Load user from Firebase if not in local database
        if (!usersDatabase[username]) {
          const user = await getUserFromFirebase(username);
          if (user) {
            usersDatabase[username] = user;
          }
        }
        
        passwordSection.style.display = 'block';
        const passwordInput = document.getElementById('user-password');
        passwordInput.placeholder = 'Enter your password to continue...';
        clearPasswordField();
        hideUserStats();
        currentUser = null;
        jugador = "";
      } else {
        passwordSection.style.display = 'none';
        currentUser = null;
        hideUserStats();
        jugador = "";
      }
    }
    
    // Handle password input for existing users
    async function handlePasswordInput() {
      const dropdown = document.getElementById('existing-users');
      const nameInput = document.getElementById('nombre-jugador');
      const passwordInput = document.getElementById('user-password');
      const existingRadio = document.getElementById('existing-user');
      
      const password = passwordInput.value;
      
      if (existingRadio.checked) {
        // Existing user password verification
        const username = dropdown.value;
        if (username && password) {
          const isValid = await verifyUserPassword(username, password);
          if (isValid) {
            passwordInput.style.borderColor = '#55efc4';
            passwordInput.style.backgroundColor = 'rgba(85, 239, 196, 0.1)';
            currentUser = await getUserFromFirebase(username);
            usersDatabase[username] = currentUser;
            showUserStats(username);
            jugador = username;
            // Show session history and all-time best score on login
            document.getElementById('user-history-panel').style.display = 'block';
            document.getElementById('user-stats').style.display = 'block';
          } else {
            passwordInput.style.borderColor = '#ff6b6b';
            passwordInput.style.backgroundColor = 'rgba(255, 107, 107, 0.1)';
            currentUser = null;
            hideUserStats();
            jugador = "";
          }
        }
      } else {
        // New user password creation
        const username = nameInput.value.trim();
        if (username && password) {
          if (password.length >= 2) {
            passwordInput.style.borderColor = '#55efc4';
            passwordInput.style.backgroundColor = 'rgba(85, 239, 196, 0.1)';
            jugador = username;
          } else {
            passwordInput.style.borderColor = '#ff6b6b';
            passwordInput.style.backgroundColor = 'rgba(255, 107, 107, 0.1)';
            jugador = "";
          }
        }
      }
    }
    
    // Handle new user name input
    function handleNewUserInput() {
      const nameInput = document.getElementById('nombre-jugador');
      const passwordSection = document.getElementById('password-section');
      const username = nameInput.value.trim();
      
      if (username) {
        // Check if user already exists
        if (usersDatabase[username]) {
          // Show warning that user exists
          nameInput.style.borderColor = '#ff6b6b';
          nameInput.style.backgroundColor = 'rgba(255, 107, 107, 0.1)';
          nameInput.title = 'This player already exists. Choose "Select existing player" to continue.';
          passwordSection.style.display = 'none';
          // Visual message for children
          nameInput.setCustomValidity('This name is already registered. Use another one or select the existing player.');
          nameInput.reportValidity();
          jugador = "";
          currentUser = null;
        } else {
          nameInput.style.borderColor = '#667eea';
          nameInput.style.backgroundColor = 'white';
          nameInput.title = '';
          nameInput.setCustomValidity('');
          passwordSection.style.display = 'block';
          const passwordInput = document.getElementById('user-password');
          passwordInput.placeholder = 'Create a simple password (minimum 2 characters)...';
          clearPasswordField();

          // Visual message for children
          if (username.length < 2) {
            nameInput.setCustomValidity('Name must be at least 2 letters.');
            nameInput.reportValidity();
            jugador = "";
          } else {
            nameInput.setCustomValidity('');
            jugador = username;
          }
      // Accessible message if no sessions exist
      if (user.sessions && user.sessions.length === 0) {
        historyList.innerHTML = '<li style="color:#aaa;font-size:0.95em;">Play a session to see your progress here!</li>';
      }
        }
        currentUser = null; // Will be created when game starts
      } else {
        passwordSection.style.display = 'none';
        jugador = "";
        currentUser = null;
      }
    }
    
    // Save user session data
    async function saveUserSession(username, score, sessionData) {
      const user = currentUser || await getUserFromFirebase(username);
      if (!user) {
        console.error('Cannot save session: user not found');
        return;
      }
      
      // Add session to history
      const session = {
        date: new Date().toISOString(),
        score: score,
        accuracy: sessionData.accuracy,
        averageTime: sessionData.averageTime,
        totalTime: sessionData.totalTime,
        challenges: sessionData.challenges
      };
      
      user.sessions.push(session);
      user.totalSessions++;
      user.lastPlayed = session.date;
      
      // Update personal best
      if (!user.personalBest || score > user.personalBest) {
        user.personalBest = score;
      }
      
      // Keep only last 50 sessions to avoid storage bloat
      if (user.sessions.length > 50) {
        user.sessions = user.sessions.slice(-50);
      }
      
      // Save to Firebase
      await saveUserToFirebase(username, user);
      
      // Update local database
      usersDatabase[username] = user;
      currentUser = user;
    }
    
    // Initialize user system
    async function initializeUserSystem() {
      await loadUsersDatabase();
      await updateUserDropdown();
      
      // Event listeners
      document.getElementById('existing-user').addEventListener('change', handleUserTypeChange);
      document.getElementById('new-user').addEventListener('change', handleUserTypeChange);
      document.getElementById('existing-users').addEventListener('change', handleExistingUserSelection);
      document.getElementById('nombre-jugador').addEventListener('input', handleNewUserInput);
      document.getElementById('user-password').addEventListener('input', handlePasswordInput);
      
      // Initialize state
      handleUserTypeChange();
    }
    
    // ============= END USER REGISTRATION SYSTEM =============
    
    let filaActual = null, colActual = null, esperando = false;
    let timeoutTrial = null;  // Timeout for next trial
    let tiempoInicio = null;
    let trialTimes = [];  // Array of response times for last 10 trials
    let trialResults = [];  // Array of correct/incorrect for last 10 trials
    let juegoIniciado = false;

    // Error matrix: erroresPorCelda[i][j] = error count for cell (i+1, j+1)
    let erroresPorCelda = Array.from({length:12}, () => Array(12).fill(0));
    let highScore = null;
    let jugador = "";

    // Cron√≥metro digital
    let cronometroInterval = null;
    let tiempoInicioCronometro = null;

    function iniciarCronometro() {
      tiempoInicioCronometro = Date.now();
      actualizarCronometro();
      if (cronometroInterval) clearInterval(cronometroInterval);
      cronometroInterval = setInterval(actualizarCronometro, 1000);
    }

    function detenerCronometro() {
      if (cronometroInterval) {
        clearInterval(cronometroInterval);
        cronometroInterval = null;
      }
    }

    function actualizarCronometro() {
      if (!tiempoInicioCronometro) {
        document.getElementById('cronometro').textContent = "‚è±Ô∏è Current session time: 00:00";
        return;
      }
      let ahora = Date.now();
      let diff = Math.floor((ahora - tiempoInicioCronometro) / 1000);
      let min = Math.floor(diff / 60);
      let seg = diff % 60;
      document.getElementById('cronometro').textContent = `‚è±Ô∏è Current session time: ${min.toString().padStart(2, '0')}:${seg.toString().padStart(2, '0')}`;
    }

    function limpiarMatriz() {
      document.querySelectorAll('#matriz td').forEach(td => {
        td.className = '';
        td.textContent = '';
      });
      document.querySelectorAll('#matriz tr').forEach(tr => {
        tr.classList.remove('highlight-row', 'red', 'green');
      });
      document.querySelectorAll('#matriz th').forEach(th => {
        th.classList.remove('highlight-col', 'red', 'green');
      });
    }

    function ocultarCruz() {
      // Remove any row/column highlight
      document.querySelectorAll('#matriz tr').forEach(tr => {
        tr.classList.remove('highlight-row', 'red', 'green');
      });
      document.querySelectorAll('#matriz th').forEach(th => {
        th.classList.remove('highlight-col', 'red', 'green');
      });
      document.querySelectorAll('#matriz td').forEach(td => {
        td.classList.remove('highlight-col', 'red', 'green');
      });
    }

    function resaltaCruz(color) {
      // Resalta fila
      document.querySelectorAll('#matriz tbody tr').forEach((tr, idx) => {
        if (idx === filaActual - 1) {
          tr.classList.remove('red', 'green');
          tr.classList.add(color);
        }
      });
      // Resalta columna (encabezado)
      document.querySelectorAll('#matriz thead th').forEach((th, idx) => {
        if (idx === colActual) {
          th.classList.remove('red', 'green');
          th.classList.add(color);
        }
      });
      // Resalta columna (todas las celdas)
      document.querySelectorAll('#matriz tbody tr').forEach(tr => {
        const tds = tr.querySelectorAll('td');
        if (tds.length >= colActual) {
          tds[colActual - 1].classList.remove('red', 'green');
          tds[colActual - 1].classList.add(color);
        }
      });
    }

    function actualizarStats(ultimoTiempo = null) {
      // Only last 10 trials
      const ultimosResultados = trialResults.slice(-10);
      const ultimosTiempos = trialTimes.slice(-10);

      // Average time for last 10 trials
      let prom = null;
      if (ultimosTiempos.length > 0) {
        const suma = ultimosTiempos.reduce((a, b) => a + b, 0);
        prom = suma / ultimosTiempos.length;
        document.getElementById('promedio-tiempo').textContent = `üìä Avg time (last 10): ${prom.toFixed(2)} s`;
      } else {
        document.getElementById('promedio-tiempo').textContent = `üìä Avg time (last 10): -- s`;
      }
      // Last trial time (hidden)
      if (ultimoTiempo !== null) {
        document.getElementById('ultimo-tiempo').textContent = `‚ö° Last trial: ${ultimoTiempo.toFixed(2)} s`;
      } else if (ultimosTiempos.length > 0) {
        document.getElementById('ultimo-tiempo').textContent = `‚ö° Last trial: ${ultimosTiempos[ultimosTiempos.length-1].toFixed(2)} s`;
      } else {
        document.getElementById('ultimo-tiempo').textContent = `‚ö° Last trial: -- s`;
      }
      // Accuracy for last 10 trials
      let porcentaje = null;
      if (ultimosResultados.length > 0) {
        const correctas = ultimosResultados.filter(x => x).length;
        porcentaje = correctas / ultimosResultados.length;
        document.getElementById('porcentaje-correctas').textContent = `‚úÖ Avg accuracy (last 10): ${(porcentaje*100).toFixed(0)}%`;
      } else {
        document.getElementById('porcentaje-correctas').textContent = `‚úÖ Avg accuracy (last 10): --%`;
      }
      // Score calculation
      let scoreText = "üéØ Current Session Score: --";
      let score = null;
      if (porcentaje !== null && prom !== null && prom > 0) {
        score = (porcentaje / prom) * 100;
        scoreText = `üéØ Current Session Score: ${score.toFixed(1)}`;
      }
      document.getElementById('score').textContent = scoreText;

      // Current Session Higher Score - only if at least 10 trials completed
      const highscoreElem = document.getElementById('highscore');
      if (trialResults.length >= 10 && trialTimes.length >= 10 && score !== null) {
        let highscorePrevio = highScore;
        if (highScore === null || score > highScore) {
          highScore = score;
          
          // Save user session data if user is logged in
          if (currentUser && jugador) {
            const sessionData = {
              accuracy: porcentaje,
              averageTime: prom,
              totalTime: (Date.now() - tiempoInicioCronometro) / 1000,
              challenges: trialResults.length
            };
            saveUserSession(jugador, score, sessionData);
            
            // Update user stats display if visible
            if (document.getElementById('user-stats').style.display !== 'none') {
              showUserStats(jugador);
            }
          }
          
          // Efecto visual: rojo, titilar, saltar y resplandor
          highscoreElem.classList.remove('highscore-flash'); // reset animation
          void highscoreElem.offsetWidth; // force reflow
          highscoreElem.classList.add('highscore-flash');
          setTimeout(() => {
            highscoreElem.classList.remove('highscore-flash');
          }, 1000);
        }
        
        // Show personal best vs session best
        if (currentUser && currentUser.personalBest && currentUser.personalBest !== highScore) {
          highscoreElem.textContent = `üèÜ Session: ${highScore.toFixed(1)} | Personal: ${currentUser.personalBest.toFixed(1)}`;
        } else {
          highscoreElem.textContent = `üèÜ All Sessions Higher Score: ${highScore.toFixed(1)}`;
        }
      } else {
        highScore = null;
        if (currentUser && currentUser.personalBest) {
          highscoreElem.textContent = `üèÜ Personal Best: ${currentUser.personalBest.toFixed(1)}`;
        } else {
          highscoreElem.textContent = "üèÜ All Sessions Higher Score: --";
        }
        highscoreElem.classList.remove('highscore-flash');
      }
      
      // Update mobile stats bar
      const mobileAvg = document.getElementById('mobile-avg');
      const mobileScore = document.getElementById('mobile-score');
      if (mobileAvg && mobileScore) {
        if (prom !== null) {
          mobileAvg.textContent = `üìä Avg: ${prom.toFixed(1)}s`;
        } else {
          mobileAvg.textContent = `üìä Avg: --`;
        }
        if (score !== null) {
          mobileScore.textContent = `üéØ Current Session Score: ${score.toFixed(1)}`;
        } else {
          mobileScore.textContent = `üéØ Current Session Score: --`;
        }
      }
    }

    async function iniciarJuego() {
      const passwordInput = document.getElementById('user-password');
      const existingRadio = document.getElementById('existing-user');
      const password = passwordInput.value;
      
      // Validate user and password
      if (!jugador || jugador.trim() === '') {
        alert('‚ö†Ô∏è Please enter your name or select an existing player before starting!');
        return;
      }
      
      if (!password || password.trim() === '') {
        alert('üîê Please enter your password to continue!');
        passwordInput.focus();
        return;
      }
      
      if (existingRadio.checked) {
        // Verify existing user password
        if (!currentUser) {
          alert('‚ùå Incorrect password! Please check your password and try again.');
          passwordInput.focus();
          passwordInput.select();
          return;
        }
      } else {
        // Create new user with password
        if (password.length < 2) {
          alert('üîê Password must be at least 2 characters long!');
          passwordInput.focus();
          return;
        }
        
        // Check if user exists in Firebase too
        const existingUser = await getUserFromFirebase(jugador.trim());
        if (existingUser || usersDatabase[jugador.trim()]) {
          alert('‚ö†Ô∏è This player name already exists! Please switch to "Select existing player" or choose a different name.');
          return;
        }
        
        try {
          currentUser = await createOrGetUser(jugador, password);
          await updateUserDropdown(); // Refresh dropdown with new user
        } catch (error) {
          console.error('Error creating user:', error);
          alert('‚ö†Ô∏è Error creating user. Please try again.');
          return;
        }
      }
      
      // Start the game
      document.getElementById('start-btn').style.display = 'none';
      document.getElementById('stop-btn').style.display = 'inline-block';
      juegoIniciado = true;
      iniciarCronometro();
      
      // Enable mobile-specific layout on small screens
      if (window.innerWidth <= 700) {
        document.body.classList.add('mobile-game-active');
        
        // Focus mobile input immediately on game start (iOS requires focus in direct user action)
        const mobileInput = document.getElementById('mobile-challenge-input');
        if (mobileInput) {
          // Multiple focus attempts for better iOS compatibility
          mobileInput.focus();
          requestAnimationFrame(() => {
            mobileInput.focus();
            // Ensure cursor is visible
            mobileInput.click();
          });
        }
      }
      
      newTrial();
    }

    async function detenerSesion() {
      if (!juegoIniciado) return;
      
      // Stop the game
      juegoIniciado = false;
      detenerCronometro();
      
      // Calculate final stats from last 10 trials
      const ultimosResultados = trialResults.slice(-10);
      const ultimosTiempos = trialTimes.slice(-10);
      
      let porcentaje = null;
      let prom = null;
      
      if (ultimosResultados.length > 0) {
        const correctas = ultimosResultados.filter(x => x).length;
        porcentaje = correctas / ultimosResultados.length;
      }
      
      if (ultimosTiempos.length > 0) {
        const suma = ultimosTiempos.reduce((a, b) => a + b, 0);
        prom = suma / ultimosTiempos.length;
      }
      
      // Calculate final score
      let finalScore = null;
      if (porcentaje !== null && prom !== null && prom > 0 && trialResults.length >= 10) {
        finalScore = (porcentaje / prom) * 100;
        
        // Save session data
        if (currentUser && jugador) {
          const sessionData = {
            accuracy: porcentaje,
            averageTime: prom,
            totalTime: (Date.now() - tiempoInicioCronometro) / 1000,
            challenges: trialResults.length
          };
          await saveUserSession(jugador, finalScore, sessionData);
          
          // Update display
          showUserStats(jugador);
        }
        
        alert(`üéÆ Session ended!\n\nüéØ Final score: ${finalScore.toFixed(1)}\n‚ö° Average: ${prom.toFixed(2)}s\n‚úÖ Accuracy: ${(porcentaje*100).toFixed(0)}%\nüî¢ Trials completed: ${trialResults.length}`);
      } else {
        alert(`üéÆ Session ended!\n\nComplete at least 10 trials to get a score.`);
      }
      
      // Reset UI
      document.getElementById('start-btn').style.display = 'inline-block';
      document.getElementById('stop-btn').style.display = 'none';
      ocultarCruz();
      
      // Clear mobile mode if active
      document.body.classList.remove('mobile-game-active');
    }

    function elegirCeldaPorErrores() {
      // Calculate errors by row and column
      let erroresFila = Array(12).fill(0);
      let erroresCol = Array(12).fill(0);
      for (let i = 0; i < 12; i++) {
        for (let j = 0; j < 12; j++) {
          erroresFila[i] += erroresPorCelda[i][j];
          erroresCol[j] += erroresPorCelda[i][j];
        }
      }
      // Build array of multiplicative weights (erroresFila[i]+1)*(erroresCol[j]+1)
      let pesos = [];
      for (let i = 0; i < 12; i++) {
        for (let j = 0; j < 12; j++) {
          pesos.push((erroresFila[i] + 1) * (erroresCol[j] + 1));
        }
      }
      // Total sum of weights
      let total = pesos.reduce((a, b) => a + b, 0);
      // Choose random number between 0 and total
      let r = Math.random() * total;
      let acumulado = 0;
      for (let idx = 0; idx < pesos.length; idx++) {
        acumulado += pesos[idx];
        if (r < acumulado) {
          let i = Math.floor(idx / 12);
          let j = idx % 12;
          return [i + 1, j + 1];
        }
      }
      // Fallback (shouldn't occur)
      return [Math.floor(Math.random() * 12) + 1, Math.floor(Math.random() * 12) + 1];
    }

    // Variables for special repetition sequence
    let repeticionActiva = false;
    let secuenciaRepeticion = [];
    let indiceSecuencia = 0;
    let celdaProblematica = null;

    function generarSecuenciaRepeticion(fila, col) {
      // Generate 10 random cells from rows/cols <= 4, distinct from each other and from problematic cell
      let posibles = [];
      for (let i = 1; i <= 4; i++) {
        for (let j = 1; j <= 4; j++) {
          if (!(i === fila && j === col)) {
            posibles.push([i, j]);
          }
        }
      }
      // Shuffle and take 10 distinct
      for (let i = posibles.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [posibles[i], posibles[j]] = [posibles[j], posibles[i]];
      }
      let intercaladas = posibles.slice(0, 10);
      // Patr√≥n:
      // Celda problem√°tica
      // Intercalada 1
      // Celda problem√°tica
      // Intercalada 2
      // Intercalada 3
      // Celda problem√°tica
      // Intercalada 4
      // Intercalada 5
      // Intercalada 6
      // Celda problem√°tica
      // Intercalada 7
      // Intercalada 8
      // Intercalada 9
      // Intercalada 10
      // Celda problem√°tica
      let secuencia = [];
      secuencia.push([fila, col]);
      secuencia.push(intercaladas[0]);
      secuencia.push([fila, col]);
      secuencia.push(intercaladas[1]);
      secuencia.push(intercaladas[2]);
      secuencia.push([fila, col]);
      secuencia.push(intercaladas[3]);
      secuencia.push(intercaladas[4]);
      secuencia.push(intercaladas[5]);
      secuencia.push([fila, col]);
      secuencia.push(intercaladas[6]);
      secuencia.push(intercaladas[7]);
      secuencia.push(intercaladas[8]);
      secuencia.push(intercaladas[9]);
      secuencia.push([fila, col]);
      return secuencia;
    }

    function activarRepeticion(fila, col) {
      repeticionActiva = true;
      celdaProblematica = [fila, col];
      secuenciaRepeticion = generarSecuenciaRepeticion(fila, col);
      indiceSecuencia = 0;
    }

    function siguienteCeldaRepeticion() {
      if (indiceSecuencia < secuenciaRepeticion.length) {
        let [f, c] = secuenciaRepeticion[indiceSecuencia];
        indiceSecuencia++;
        return [f, c];
      } else {
        repeticionActiva = false;
        secuenciaRepeticion = [];
        indiceSecuencia = 0;
        celdaProblematica = null;
        return null;
      }
    }

    // Mobile Challenge Functions
    function updateMobileChallenge() {
      const questionElem = document.getElementById('mobile-challenge-question');
      const inputElem = document.getElementById('mobile-challenge-input');
      const feedbackElem = document.getElementById('mobile-feedback');
      
      if (!juegoIniciado || filaActual === null || colActual === null) {
        if (questionElem) questionElem.textContent = '? √ó ? = ?';
        if (inputElem) inputElem.value = '';
        if (feedbackElem) feedbackElem.textContent = '';
        return;
      }
      
      if (questionElem) {
        questionElem.textContent = `${filaActual} √ó ${colActual} = ?`;
      }
      if (inputElem) {
        inputElem.value = '';
        
        // Aggressive focus for iOS compatibility - multiple attempts with different timing
        inputElem.focus();
        requestAnimationFrame(() => {
          inputElem.focus();
          inputElem.click();
        });
        setTimeout(() => {
          inputElem.focus();
        }, 50);
        setTimeout(() => {
          inputElem.focus();
        }, 150);
        
        // Auto-submit when 2-3 digits are entered (for fast gameplay on mobile)
        inputElem.oninput = function() {
          const value = this.value;
          // Auto-submit if 3 digits entered (max is 144)
          if (value.length === 3) {
            setTimeout(() => verificarRespuestaMobile(), 100);
          }
        };
      }
      if (feedbackElem) {
        feedbackElem.textContent = '';
      }
    }

    function verificarRespuestaMobile() {
      if (!esperando) return;
      const input = document.getElementById('mobile-challenge-input');
      if (!input) return;
      const valor = parseInt(input.value, 10);
      
      // Call the main verification logic
      verificarRespuestaCommon(valor);
      
      // Aggressive refocus to keep keyboard visible - multiple attempts
      if (input) {
        input.focus();
        requestAnimationFrame(() => {
          input.focus();
        });
        setTimeout(() => {
          input.focus();
        }, 10);
        setTimeout(() => {
          input.focus();
        }, 50);
        setTimeout(() => {
          input.focus();
        }, 100);
      }
    }

    function verificarRespuestaCommon(valor) {
      if (!esperando) return;
      const correcto = filaActual * colActual;
      let celda = document.querySelector('#matriz td[data-row="'+filaActual+'"][data-col="'+colActual+'"]');
      
      let tiempoRespuesta = tiempoInicio ? (Date.now() - tiempoInicio) / 1000 : null;
      if (tiempoRespuesta !== null) {
        trialTimes.push(tiempoRespuesta);
        if (trialTimes.length > 10) trialTimes.shift();
      }

      // --- New repetition logic ---
      let activarSecuencia = false;
      if (valor !== correcto || (tiempoRespuesta !== null && tiempoRespuesta > 6)) {
        activarSecuencia = true;
      }

      if (valor === correcto) {
        if (celda) {
          celda.innerHTML = correcto;
          celda.classList.remove('target');
          celda.classList.add('correct');
        }
        document.getElementById('feedback').textContent = 'üéâ Correct! Well done!';
        document.getElementById('mobile-feedback').textContent = 'üéâ Correct! Well done!';
        resaltaCruz('green');
        trialResults.push(true);
        if (trialResults.length > 10) trialResults.shift();
        actualizarStats(tiempoRespuesta);
        esperando = false;
        timeoutTrial = setTimeout(newTrial, 1000);
      } else {
        if (celda) {
          celda.innerHTML = valor || '';
          celda.classList.remove('target');
          celda.classList.add('incorrect');
        }
        document.getElementById('feedback').textContent = '';
        document.getElementById('mobile-feedback').textContent = `‚ùå Incorrect, it was ${correcto}`;
        resaltaCruz('red');
        trialResults.push(false);
        if (trialResults.length > 10) trialResults.shift();
        erroresPorCelda[filaActual-1][colActual-1]++;
        actualizarStats(tiempoRespuesta);
        esperando = false;
        mostrarModalIncorrecto(`Incorrect, it was ${correcto}`);
        timeoutTrial = setTimeout(newTrial, 2000);
      }

      // If applicable, activate repetition sequence (this overwrites any previous sequence)
      if (activarSecuencia) {
        activarRepeticion(filaActual, colActual);
      }
    }

    function newTrial() {
      if (!juegoIniciado) {
        limpiarMatriz();
        ocultarCruz();
        updateMobileChallenge();
        return;
      }
      if (timeoutTrial) {
        clearTimeout(timeoutTrial);
        timeoutTrial = null;
      }
      limpiarMatriz();

      // Cell selection based on repetition rule or normal
      let celda;
      if (repeticionActiva) {
        celda = siguienteCeldaRepeticion();
        if (!celda) {
          // End special sequence, return to normal rule
          [filaActual, colActual] = elegirCeldaPorErrores();
        } else {
          [filaActual, colActual] = celda;
        }
      }
      if (!repeticionActiva) {
        [filaActual, colActual] = elegirCeldaPorErrores();
      }

      // Update mobile challenge display
      updateMobileChallenge();

      // Highlight row
      document.querySelectorAll('#matriz tbody tr').forEach((tr, idx) => {
        if (idx === filaActual - 1) tr.classList.add('highlight-row');
      });
      // Highlight column (all cells in the column)
      document.querySelectorAll('#matriz thead th').forEach((th, idx) => {
        if (idx === colActual) th.classList.add('highlight-col');
      });
      document.querySelectorAll('#matriz tbody tr').forEach(tr => {
        const tds = tr.querySelectorAll('td');
        if (tds.length >= colActual) {
          tds[colActual - 1].classList.add('highlight-col');
        }
      });
      let celdaElem = document.querySelector('#matriz td[data-row="'+filaActual+'"][data-col="'+colActual+'"]');
      if (celdaElem) {
        celdaElem.classList.add('target');
        celdaElem.innerHTML = '<input type="number" class="cell-input" id="cell-input" autocomplete="off">';
        document.getElementById('feedback').textContent = '';
        esperando = true;
        tiempoInicio = Date.now();
        setTimeout(() => {
          const cellInput = document.getElementById('cell-input');
          if (cellInput) cellInput.focus();
        }, 50);
        const cellInputHandler = document.getElementById('cell-input');
        if (cellInputHandler) {
          cellInputHandler.onkeydown = function(e) {
            if (e.key === 'Enter') {
              verificarRespuesta();
            }
          };
        }
      }
    }

    function verificarRespuesta() {
      if (!esperando) return;
      const input = document.getElementById('cell-input');
      if (!input) return;
      const valor = parseInt(input.value, 10);
      
      // Call the common verification logic
      verificarRespuestaCommon(valor);
    }

    // Modal simple para mostrar el error
    function mostrarModalIncorrecto(mensaje) {
      let modal = document.createElement('div');
      modal.id = 'modal-incorrecto';
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.width = '100vw';
      modal.style.height = '100vh';
      modal.style.background = 'rgba(0,0,0,0.5)';
      modal.style.display = 'flex';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
      modal.style.zIndex = '9999';
      modal.innerHTML = `<div style="background: linear-gradient(135deg, #ff7675 0%, #d63031 100%); padding: 30px 50px; border-radius: 25px; font-size: 1.8em; color: white; font-weight: 700; box-shadow: 0 10px 40px rgba(214, 48, 49, 0.5); font-family: 'Fredoka One', cursive; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); animation: modalPop 0.5s ease;">‚ùå ${mensaje}</div>`;
      document.body.appendChild(modal);
      setTimeout(() => {
        if (modal.parentNode) modal.parentNode.removeChild(modal);
      }, 1200);
    }

    function reiniciarJuego() {
      detenerCronometro();
      // Reset all state variables
      filaActual = null;
      colActual = null;
      esperando = false;
      timeoutTrial = null;
      tiempoInicio = null;
      trialTimes = [];
      trialResults = [];
      juegoIniciado = false;
      erroresPorCelda = Array.from({length:12}, () => Array(12).fill(0));
      highScore = null;
      // Clear the interface
      document.getElementById('start-btn').style.display = '';
      document.getElementById('stop-btn').style.display = 'none';
      document.getElementById('cronometro').textContent = "‚è±Ô∏è Current session time: 00:00";
      document.getElementById('ultimo-tiempo').textContent = "‚ö° Last trial: -- s";
      document.getElementById('feedback').textContent = "";
      document.getElementById('score').textContent = "üéØ Current Session Score: --";
      document.getElementById('highscore').textContent = "üèÜ Session best: --";
      document.getElementById('promedio-tiempo').textContent = "üìä Avg time (last 10): -- s";
      document.getElementById('porcentaje-correctas').textContent = "‚úÖ Avg accuracy (last 10): --%";
      limpiarMatriz();
      ocultarCruz();
      updateMobileChallenge();
      
      // Remove mobile game active class
      document.body.classList.remove('mobile-game-active');
    }

    // Al cargar, oculta la cruz y muestra el bot√≥n de inicio
    window.onload = function() {
      actualizarStats();
      juegoIniciado = false;
      document.getElementById('start-btn').style.display = '';
      limpiarMatriz();
      ocultarCruz();
      detenerCronometro();
      document.getElementById('cronometro').textContent = "‚è±Ô∏è Current session time: 00:00";
      document.getElementById('ultimo-tiempo').textContent = "‚ö° Last trial: -- s";
      // Make sure the reset button is visible on load
      document.getElementById('reset-btn').style.display = '';
      
      // Initialize mobile challenge display
      updateMobileChallenge();
      
      // Add Enter key listener for mobile input
      const mobileInput = document.getElementById('mobile-challenge-input');
      if (mobileInput) {
        mobileInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            verificarRespuestaMobile();
          }
        });
      }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    document.getElementById('screenshot-btn').onclick = function() {
      // Selecciona el √°rea que quieres capturar (puedes ajustar el selector)
      const area = document.getElementById('juego-controls');
      if (typeof html2canvas !== "function" && typeof html2canvas !== "object") {
        alert('No se pudo cargar html2canvas. Intenta recargar la p√°gina.');
        return;
      }
      html2canvas(area).then(canvas => {
        // Crea un enlace para descargar la imagen
        const link = document.createElement('a');
        link.download = 'pantallazo_score.png';
        link.href = canvas.toDataURL();
        link.click();
        // Opcional: muestra un mensaje
        alert('üì∏ Screenshot saved! You can send it to your parent and ask for your prize! üéÅ‚ú®');
      }).catch(err => {
        alert('‚ö†Ô∏è An error occurred while generating the screenshot.');
        console.error(err);
      });
    };
    
    // Initialize user system when page loads
    document.addEventListener('DOMContentLoaded', async function() {
      await initializeUserSystem();
    });
  </script>
</body>
</html>